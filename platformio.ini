; =============================================================================
; PlatformIO Configuration for Nano-Edge AI Project
; =============================================================================
; Professional embedded C development for ATmega328P with testing support.
; Follows MISRA-C, Engineer/JPL, and BARR-C coding standards.
; =============================================================================

[platformio]
default_envs = uno

; =============================================================================
; Common settings shared across environments
; =============================================================================
[common]
build_flags =
    -std=gnu99
    -Os
    -Wall
    -Wextra
    -Wpedantic
    -Wno-unused-function
    -Isrc/hal
    -Isrc/hdc
    -Isrc/app

; =============================================================================
; Arduino Uno (ATmega328P) - Production Target
; =============================================================================
[env:uno]
platform = atmelavr
board = uno
framework = arduino

build_flags =
    ${common.build_flags}

; Build source filter - include all source directories
build_src_filter =
    +<app/>
    +<hal/>
    +<hdc/>

; Upload settings
upload_speed = 115200

; Serial monitor for debugging
monitor_speed = 9600

; =============================================================================
; Native (PC) - Unit Testing Environment
; =============================================================================
; Run tests with: pio test -e native
; =============================================================================
[env:native]
platform = native

build_flags =
    -std=c99
    -g
    -O0
    -Wall
    -Wextra
    -DUNIT_TEST
    -Isrc/hdc
    -Itest/mocks

; Don't build main application for tests
build_src_filter =
    +<hdc/>
    -<app/>
    -<hal/>

; Unity test framework
lib_deps =
    throwtheswitch/Unity@^2.5.2

test_build_src = true

; =============================================================================
; Static Analysis Environment (Optional)
; =============================================================================
; Run with: pio check -e uno
; =============================================================================
[env:check]
platform = atmelavr
board = uno
framework = arduino

build_flags = ${common.build_flags}

check_tool = cppcheck
check_flags =
    cppcheck: --enable=all --std=c99 --suppress=missingIncludeSystem

; =============================================================================
; Code Coverage Environment
; =============================================================================
; Run with: pio test -e coverage
; Generates gcov data for coverage analysis with gcovr/lcov
;
; IMPORTANT: Use `pio test -e coverage`, NOT `pio run -e coverage`
; The HDC module is a library - Unity test framework provides main()
; =============================================================================
[env:coverage]
platform = native

; Compiler flags for coverage instrumentation
; --coverage: enables both -fprofile-arcs and -ftest-coverage, plus links -lgcov
build_flags =
    -std=c99
    -g
    -O0
    -Wall
    -Wextra
    -DUNIT_TEST
    -Isrc/hdc
    -Itest/mocks
    -Itest
    --coverage

; Ensure coverage libraries are linked
; The --coverage flag should handle this, but we add explicitly for safety
extra_scripts = pre:scripts/coverage_link.py

; Only build HDC module for coverage (same as native)
build_src_filter =
    +<hdc/>
    -<app/>
    -<hal/>

; Unity test framework
lib_deps =
    throwtheswitch/Unity@^2.5.2

test_build_src = true
